<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Field Project Dashboard - BAFs App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    // Prevent theme flash
    (function() {
      const theme = new URLSearchParams(window.location.search).get('theme') || localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      if (theme) localStorage.setItem('theme', theme);
    })();
  </script>

  <style>
    /* --- styles same as before --- */
    :root {
      --primary-accent: #b84fff;
      --primary-gradient: linear-gradient(135deg, #b84fff, #8f00ff);
      --font-family: 'Inter', sans-serif;
      --bg-gradient-light: linear-gradient(180deg, #f5f5f7, #e9e9ed);
      --card-bg-light: rgba(255, 255, 255, 0.8);
      --text-primary-light: #121212;
      --text-secondary-light: #5f5f5f;
      --border-color-light: #e0e0e0;
      --shadow-light: 0 4px_25px rgba(0, 0, 0, 0.07);
      --bg-gradient-dark: linear-gradient(180deg, #2a2a3d, #1e1e2e);
      --card-bg-dark: rgba(42, 42, 61, 0.8);
      --text-primary-dark: #f0f0f0;
      --text-secondary-dark: #a0a0b0;
      --border-color-dark: #4a4a6a;
      --shadow-dark: 0 4px_25px rgba(0, 0, 0, 0.2);
    }
    [data-theme="light"] {
      --bg-gradient: var(--bg-gradient-light);
      --card-bg: var(--card-bg-light);
      --text-primary: var(--text-primary-light);
      --text-secondary: var(--text-secondary-light);
      --border-color: var(--border-color-light);
      --shadow: var(--shadow-light);
    }
    [data-theme="dark"] {
      --bg-gradient: var(--bg-gradient-dark);
      --card-bg: var(--card-bg-dark);
      --text-primary: var(--text-primary-dark);
      --text-secondary: var(--text-secondary-dark);
      --border-color: var(--border-color-dark);
      --shadow: var(--shadow-dark);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-family);
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }
    .hidden { display: none !important; }
    #app-container { width: 100%; max-width: 42rem; display: flex; flex-direction: column; gap: 1.5rem; }
    .upload-btn { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--primary-gradient); color: white; padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; }
    .upload-btn:hover { transform: translateY(-2px); }
  </style>
</head>
<body>

  <div id="app-container">
    <header></header>
    <main id="main-content">
      <div id="loading"><p>Fetching project details...</p></div>
      <div id="error" class="hidden"><h2 id="error-title"></h2><p id="error-message"></p></div>
      <div id="project-details" class="hidden">
        <div class="main-card">
          <div class="card-content">
            <div class="student-info">
              <div class="student-initials" id="student-initials"></div>
              <div><h2 id="student-name"></h2><p id="student-id"></p></div>
            </div>
            <div class="project-details-grid">
              <div class="project-detail-item"><h3>Project Title</h3><p id="project-title">No project assigned.</p></div>
              <div id="project-type-container" class="project-detail-item"><h3>Project Type</h3><span id="project-type"></span></div>
            </div>
          </div>
          <div id="file-upload-section" class="card-footer-section hidden"><h3>Final Project Submission</h3><div id="upload-ui"></div></div>
        </div>
      </div>
    </main>
    <footer><p>&copy; 2025 BAF Project Management. All Rights Reserved.</p></footer>
  </div>

  <!-- ✅ jsPDF UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const SUPABASE_URL = 'https://fuovcuzaxfkyqrridrgy.supabase.co';
    const SUPABASE_KEY = 'YOUR_PUBLIC_ANON_KEY';
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const projectDetailsEl = document.getElementById('project-details');

    function showError(title, message) {
      loadingEl.style.display = 'none';
      errorEl.classList.remove('hidden');
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-message').textContent = message;
    }

    async function fetchStudentData(studentId) {
      const { data: student } = await supabaseClient.from('students').select('*').eq('studentid', studentId).single();
      return student;
    }
    async function fetchProjectData(studentId) {
      const { data: assignment } = await supabaseClient.from('projectassignments').select('topicid').eq('studentid', studentId).single();
      if (!assignment) return { topic: null };
      const { data: topic } = await supabaseClient.from('topics').select('*').eq('topicid', assignment.topicid).single();
      return { topic };
    }

    // === PDF Generator ===
    function getSalutation(gender) {
      if (!gender) return "";
      const g = gender.toLowerCase();
      return g === "male" ? "Mr." : g === "female" ? "Ms." : "";
    }

    function generateDeclaration(student, topic) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const salutation = getSalutation(student.gender);
      const studentName = `${salutation} ${student.name}`;
      const topicName = topic.topicname;

      doc.addImage("https://i.ibb.co/jvfmpTh3/image.png", "PNG", 85, 10, 40, 20);
      doc.setFontSize(14);
      doc.text("DECLARATION", 105, 40, { align: "center" });
      doc.setFontSize(12);
      doc.text(
        `I, ${studentName}, student of B.K. Birla Night College, studying in S.Y. BCom,\n` +
        `hereby declare that I have completed the field project entitled "${topicName}".\n` +
        `The report work is original and the data included is true.\n\n` +
        `Due credit is extended on the work of literature/secondary survey.\n\n\n\n` +
        `Signature of the student with date\n\n${studentName}`,
        20, 55
      );
      return doc;
    }

    function generateCertificate(student, topic) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const salutation = getSalutation(student.gender);
      const studentName = `${salutation} ${student.name}`;
      const topicName = topic.topicname;

      doc.addImage("https://i.ibb.co/jvfmpTh3/image.png", "PNG", 85, 10, 40, 20);
      doc.setFontSize(14);
      doc.text("CERTIFICATE", 105, 40, { align: "center" });
      doc.setFontSize(12);
      doc.text(
        `I hereby certify that, ${studentName}, student of B.K. Birla Night College,\n` +
        `studying in S.Y. BCom (A&F), has completed a project titled "${topicName}"\n` +
        `for academic year 2025-26. To the best of my knowledge, the work is original.\n\n\n\n` +
        `Internal Guide                      Head of the Department                      Principal`,
        20, 55
      );
      return doc;
    }

    function addDownloadButtons(student, topic) {
      const uploadUI = document.getElementById('upload-ui');
      const btnDiv = document.createElement('div');
      btnDiv.style.marginTop = "1rem";
      btnDiv.innerHTML = `
        <button id="download-declaration" class="upload-btn">Download Declaration</button>
        <button id="download-certificate" class="upload-btn" style="margin-left:10px;">Download Certificate</button>
      `;
      uploadUI.appendChild(btnDiv);

      document.getElementById("download-declaration").onclick = () => generateDeclaration(student, topic).save("Declaration.pdf");
      document.getElementById("download-certificate").onclick = () => generateCertificate(student, topic).save("Certificate.pdf");
    }

    async function fetchAndDisplayFileUploadStatus(topicId, student) {
      const uploadUI = document.getElementById('upload-ui');
      document.getElementById('file-upload-section').classList.remove('hidden');

      const { data: file } = await supabaseClient.from('project_files').select('*').eq('topic_id', topicId).single();
      if (!file) return uploadUI.innerHTML = "<p>No file uploaded yet.</p>";

      if (file.status === "Approved") {
        uploadUI.innerHTML = `<div style="color:green">✅ Approved</div>`;
        addDownloadButtons(student, { topicname: file.topic_name || "Project" });
      } else {
        uploadUI.innerHTML = `<div style="color:blue">⏳ ${file.status}</div>`;
      }
    }

    window.onload = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const studentIdParam = urlParams.get('id');
      if (!studentIdParam) return showError("No Student ID", "Provide ?id=123");

      try {
        const studentId = parseInt(studentIdParam, 10);
        const [student, projectData] = await Promise.all([fetchStudentData(studentId), fetchProjectData(studentId)]);
        document.getElementById('student-name').textContent = student.name;
        document.getElementById('student-id').textContent = `Student ID: ${student.studentid}`;
        document.getElementById('student-initials').textContent = student.name[0].toUpperCase();
        if (projectData.topic) {
          document.getElementById('project-title').textContent = projectData.topic.topicname;
          fetchAndDisplayFileUploadStatus(projectData.topic.topicid, student);
        }
        loadingEl.style.display = 'none';
        projectDetailsEl.classList.remove('hidden');
      } catch (e) {
        showError("Error", e.message);
      }
    };
  </script>
</body>
</html>
