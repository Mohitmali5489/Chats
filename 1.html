<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Project Dashboard - BAFs App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
      // This script runs early to prevent a "flash of the wrong theme."
      (function() {
        const theme = new URLSearchParams(window.location.search).get('theme') || localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        if (theme) localStorage.setItem('theme', theme);
      })();
    </script>

    <style>
        /* üé® --- Color & Theme Variables --- üé® */
        :root {
            --primary-accent: #b84fff;
            --primary-gradient: linear-gradient(135deg, #b84fff, #8f00ff);
            --font-family: 'Inter', sans-serif;
            
            --bg-gradient-light: linear-gradient(180deg, #f5f5f7, #e9e9ed);
            --card-bg-light: rgba(255, 255, 255, 0.8);
            --text-primary-light: #121212;
            --text-secondary-light: #5f5f5f;
            --border-color-light: #e0e0e0;
            --shadow-light: 0 4px_25px rgba(0, 0, 0, 0.07);

            --bg-gradient-dark: linear-gradient(180deg, #2a2a3d, #1e1e2e);
            --card-bg-dark: rgba(42, 42, 61, 0.8);
            --text-primary-dark: #f0f0f0;
            --text-secondary-dark: #a0a0b0;
            --border-color-dark: #4a4a6a;
            --shadow-dark: 0 4px_25px rgba(0, 0, 0, 0.2);
        }
        
        [data-theme="light"] {
            --bg-gradient: var(--bg-gradient-light);
            --card-bg: var(--card-bg-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-color-light);
            --shadow: var(--shadow-light);
        }

        [data-theme="dark"] {
            --bg-gradient: var(--bg-gradient-dark);
            --card-bg: var(--card-bg-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-color-dark);
            --shadow: var(--shadow-dark);
        }
        
        /* üß± --- Base & Layout Styles --- üß± */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-family);
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }

        .hidden { display: none !important; }

        #app-container {
            width: 100%;
            max-width: 42rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* üîù --- Header --- üîù */
        header { text-align: center; }
        header h1 {
            font-size: 2.25rem; /* 36px */
            font-weight: 700;
        }
        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* üîÑ --- Loading & Animation --- üîÑ */
        #loading { text-align: center; padding: 2rem; }
        .loader { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .loader-dot { width: 0.75rem; height: 0.75rem; background-color: var(--primary-accent); border-radius: 50%; animation: pulse 1.4s infinite ease-in-out both; }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes pulse { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        #loading p { font-size: 1.125rem; color: var(--text-secondary); }

        @keyframes card-enter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #project-details.loaded {
            animation: card-enter 0.6s ease-out forwards;
        }
        
        /* üìÑ --- Card & Content Styles --- üìÑ */
        #error { background: var(--card-bg); border: 1px solid var(--border-color); backdrop-filter: blur(10px); box-shadow: var(--shadow); padding: 2rem; border-radius: 1rem; text-align: center; }
        #error-title { font-size: 1.5rem; font-weight: 700; color: #ef4444; }
        #error-message { margin-top: 0.5rem; color: var(--text-secondary); }

        .main-card { background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1rem; box-shadow: var(--shadow); overflow: hidden; }
        .card-content { padding: 1.5rem; }
        @media (min-width: 640px) { .card-content { padding: 2rem; } }

        .student-info { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .student-initials { width: 4rem; height: 4rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; color: white; background: var(--primary-gradient); flex-shrink: 0; }
        #student-name { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        #student-id { font-size: 0.875rem; color: var(--text-secondary); }
        
        .project-details-grid { display: grid; gap: 1.5rem; }
        .project-detail-item h3 { font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--primary-accent); margin-bottom: 0.25rem; }
        #project-title { font-size: 1.25rem; line-height: 1.6; color: var(--text-primary); }
        #project-type { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.875rem; font-weight: 500; border-radius: 9999px; }

        .card-footer-section { padding: 1.5rem; border-top: 1px solid var(--border-color); background: rgba(0,0,0,0.02); }
        @media (min-width: 640px) { .card-footer-section { padding: 1.5rem 2rem; } }
        [data-theme="dark"] .card-footer-section { background: rgba(0,0,0,0.1); }
        .card-footer-section h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        
        #team-members-list { list-style: none; display: grid; gap: 0.5rem; }
        #team-members-list li { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border-radius: 6px; }

        .upload-btn { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--primary-gradient); color: white; padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(143,0,255,0.3); }
        .upload-btn:disabled { background: var(--text-secondary); cursor: not-allowed; transform: none; box-shadow: none; }
        
        footer { text-align: center; font-size: 0.875rem; color: var(--text-secondary); }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            
        </header>

        <main id="main-content">
            <div id="loading"><div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div><p>Fetching project details...</p></div>
            <div id="error" class="hidden"><h2 id="error-title"></h2><p id="error-message"></p></div>

            <div id="project-details" class="hidden">
                <div class="main-card">
                    <div class="card-content">
                        <div class="student-info">
                            <div class="student-initials" id="student-initials"></div>
                            <div><h2 id="student-name"></h2><p id="student-id"></p></div>
                        </div>
                        <div class="project-details-grid">
                            <div class="project-detail-item"><h3>Project Title</h3><p id="project-title">No project assigned.</p></div>
                            <div id="project-type-container" class="project-detail-item"><h3>Project Type</h3><span id="project-type"></span></div>
                        </div>
                    </div>
                    <div id="team-members-section" class="card-footer-section hidden"><h3>Team Members</h3><ul id="team-members-list"></ul></div>
                    <div id="file-upload-section" class="card-footer-section hidden"><h3>Final Project Submission</h3><div id="upload-ui"></div></div>
                </div>
            </div>
        </main>
        
        <footer><p>&copy; 2025 BAF Project Management. All Rights Reserved.</p></footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://fuovcuzaxfkyqrridrgy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZjdXpheGZreXFycmlkcmd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NzIyMjAsImV4cCI6MjA2MTA0ODIyMH0._PkkfWXcn4j6cjBh-yLJjDevrmhuxKxVbcdQUSgCsSk';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const projectDetailsEl = document.getElementById('project-details');
        const errorTitleEl = document.getElementById('error-title');
        const errorMessageEl = document.getElementById('error-message');
        
        let currentStudentData = null;
        let currentProjectData = null;

        function showError(title, message) {
            loadingEl.style.display = 'none';
            projectDetailsEl.classList.add('hidden');
            errorTitleEl.textContent = title;
            errorMessageEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        async function fetchStudentData(studentId) {
            const { data: student, error } = await supabaseClient.from('students').select('*').eq('studentid', studentId).single();
            if (error || !student) throw new Error('Student not found. Please check the ID in the URL.');
            return student;
        }

        async function fetchProjectData(studentId) {
            const { data: assignment, error } = await supabaseClient.from('projectassignments').select('topicid').eq('studentid', studentId).single();
            if (error || !assignment) return { topic: null, team: [] };
            
            const topicId = assignment.topicid;
            const { data: topic, error: topicError } = await supabaseClient.from('topics').select('*').eq('topicid', topicId).single();
            if (topicError) throw new Error('Could not retrieve project details.');

            const { data: teamAssignments, error: teamError } = await supabaseClient.from('projectassignments').select('studentid').eq('topicid', topicId);
            if (teamError) throw new Error('Could not retrieve team members.');
            
            const teamMemberIds = teamAssignments.map(a => a.studentid);
            const { data: teamMembers, error: membersError } = await supabaseClient.from('students').select('studentid, name').in('studentid', teamMemberIds);
            if (membersError) throw new Error('Could not retrieve team member details.');

            return { topic, team: teamMembers };
        }

        function getUploadFormHTML(isResubmission = false) {
            const title = isResubmission ? 'Your previous submission was rejected. Please upload a new file.' : 'Your group has not submitted the project file yet.';
            const buttonText = isResubmission ? 'Upload New File' : 'Upload and Submit';
            return `
                <p style="color: var(--text-secondary);">${title}</p>
                <div style="margin-top: 1rem;">
                    <input type="file" id="file-input" accept=".pdf,.doc,.docx,.zip" class="hidden">
                    <button id="select-file-btn" class="upload-btn">Select File</button>
                    <p id="file-chosen" style="color: var(--text-secondary); font-size: 0.9em; margin-top: 0.75rem;">No file chosen</p>
                    <button id="upload-btn" class="upload-btn" style="margin-top: 0.5rem;" disabled>${buttonText}</button>
                    <div id="upload-status" style="font-size: 0.875rem; margin-top: 0.5rem;"></div>
                </div>
            `;
        }
        
        async function fetchAndDisplayFileUploadStatus(topicId, currentStudentId) {
            const uploadUI = document.getElementById('upload-ui');
            document.getElementById('file-upload-section').classList.remove('hidden');

            const { data: file, error } = await supabaseClient.from('project_files')
                .select('*, students(name)')
                .eq('topic_id', topicId)
                .single();

            if (!file) {
                uploadUI.innerHTML = getUploadFormHTML(false);
                setupUploadListeners(topicId, currentStudentId, false);
                return;
            }

            const status = file.status || 'Pending';
            const comments = file.mentor_comments;
            const uploader = file.students ? file.students.name : 'a team member';
            const uploadDate = new Date(file.uploaded_at).toLocaleDateString();

            let statusHTML = '';

            switch (status) {
                case 'Approved':
                    statusHTML = `
                        <div style="background-color: rgba(34, 197, 94, 0.1); border-left: 4px solid #22c55e; padding: 1rem; border-radius: 0 0.5rem 0.5rem 0;">
                            <h4 style="color: #166534; font-weight: 700;">‚úÖ Approved</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 0.25rem;">Submitted by <strong>${uploader}</strong> on ${uploadDate}</p>
                            ${comments ? `<p style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(34, 197, 94, 0.2); color: var(--text-secondary);"><strong>Mentor Feedback:</strong> ${comments}</p>` : ''}
                            <div style="margin-top: 1rem;">
                                <button id="download-document-btn" class="upload-btn">Download Certificate & Declaration</button>
                            </div>
                        </div>`;
                    break;
                case 'Rejected':
                    statusHTML = `
                        <div style="background-color: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0 0.5rem 0.5rem 0;">
                            <h4 style="color: #991b1b; font-weight: 700;">‚ùå Rejected - Resubmission Required</h4>
                             <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 0.25rem;">Last submission by <strong>${uploader}</strong> on ${uploadDate}</p>
                            ${comments ? `<p style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(239, 68, 68, 0.2); color: var(--text-secondary);"><strong>Mentor Feedback:</strong> ${comments}</p>` : ''}
                            <button id="resubmit-btn" class="upload-btn" style="margin-top: 1rem;">Resubmit File</button>
                        </div>`;
                    break;
                default: // Pending
                    statusHTML = `
                        <div style="background-color: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 0 0.5rem 0.5rem 0;">
                            <h4 style="color: #1e40af; font-weight: 700;">‚è≥ Pending Review</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 0.25rem;">Your file has been submitted and is awaiting feedback from your mentor.</p>
                        </div>`;
                    break;
            }
            uploadUI.innerHTML = statusHTML;
            
            if (status === 'Approved') {
                document.getElementById('download-document-btn').addEventListener('click', generateAndDownloadDocument);
            }
            
            if (status === 'Rejected') {
                document.getElementById('resubmit-btn').addEventListener('click', () => {
                    uploadUI.innerHTML = getUploadFormHTML(true);
                    setupUploadListeners(topicId, currentStudentId, true);
                });
            }
        }

        function setupUploadListeners(topicId, currentStudentId, isResubmission) {
            const fileInput = document.getElementById('file-input');
            const selectBtn = document.getElementById('select-file-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const fileChosenEl = document.getElementById('file-chosen');
            const uploadStatusEl = document.getElementById('upload-status');

            if (!selectBtn) return;
            selectBtn.onclick = () => fileInput.click();
            
            fileInput.onchange = () => {
                if (fileInput.files.length > 0) {
                    fileChosenEl.textContent = fileInput.files[0].name;
                    uploadBtn.disabled = false;
                } else {
                    fileChosenEl.textContent = 'No file chosen';
                    uploadBtn.disabled = true;
                }
            };

            uploadBtn.onclick = async () => {
                const file = fileInput.files[0];
                if (!file) return;

                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                const filePath = `${topicId}_${Date.now()}_${file.name.replace(/\s/g, '_')}`;

                try {
                    const { error: uploadError } = await supabaseClient.storage.from('FP').upload(filePath, file);
                    if (uploadError) throw uploadError;
                    
                    const fileData = {
                        topic_id: topicId,
                        file_path: filePath,
                        uploader_student_id: currentStudentId,
                        uploaded_at: new Date(),
                        status: 'Pending',
                        mentor_comments: null
                    };

                    const { error: dbError } = isResubmission
                        ? await supabaseClient.from('project_files').update(fileData).eq('topic_id', topicId)
                        : await supabaseClient.from('project_files').insert(fileData);

                    if (dbError) throw dbError;
                    
                    uploadStatusEl.textContent = '‚úÖ Success! File submitted for review.';
                    uploadStatusEl.style.color = '#22c55e';
                    setTimeout(() => fetchAndDisplayFileUploadStatus(topicId, currentStudentId), 1500);
                } catch (error) {
                    console.error('Upload failed:', error);
                    uploadStatusEl.textContent = `‚ùå Error: ${error.message}`;
                    uploadStatusEl.style.color = '#ef4444';
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = isResubmission ? 'Upload New File' : 'Upload and Submit';
                }
            };
        }

        function getSalutation(gender) {
            if (gender && gender.toLowerCase() === 'female') return 'Ms.';
            return 'Mr.';
        }

        function generateAndDownloadDocument() {
            const student = currentStudentData;
            const topic = currentProjectData.topic;
            const salutation = getSalutation(student.gender);
            const studentName = `${salutation} ${student.name}`;

            const contentHTML = `
                <div style="box-sizing: border-box; border: 2px solid #000; padding: 0.5in; font-family: 'Times New Roman', serif; color: black; font-size: 12pt; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                    
                    <div>
                        <h1 style="text-align: center; font-weight: bold; text-decoration: underline; font-size: 16pt; margin-bottom: 0.25in;">DECLARATION</h1>
                        <div style="line-height: 1.5; text-align: justify;">
                            <p style="margin-bottom: 0.2in;">
                                I <strong>${studentName}</strong>, Student of B.K. Birla Night College, Institute studying In S.Y. BCom. Hereby declare that I have completed the field project entitled <strong>"${topic.topicname}"</strong>. In the area of commerce during the academic year 2025-26.
                            </p>
                            <p style="margin-bottom: 0.2in;">
                                The report work is original and the information / data included in the report is true emerging from the primary and / secondary data gathered and analyzed as part of this project.
                            </p>
                            <p>
                                Due credit is extended on the work of Literature/secondary survey by endorsing it in the bibliography as per prescribed format.
                            </p>
                        </div>
                        <div style="text-align: center; margin-top: 0.5in;">
                             <p>Signature of the student with date</p>
                             <p style="margin-top: 0.25in;"><strong>(${studentName})</strong></p>
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid #ccc; margin: 0.4in 0;" />

                    <div style="text-align: center;">
                        <img src="https://i.ibb.co/jvfmpTh3/image.png" alt="Logo" style="width: 100px; height: auto;">
                        <p style="font-size: 14pt; font-weight: bold; margin: 0.1in 0 0 0;">Kalyan Citizens‚Äô Education Society‚Äôs</p>
                        <p style="font-size: 16pt; font-weight: bold; margin: 0;">B. K. Birla Night Arts, Science and Commerce College, Kalyan</p>
                        <p style="margin: 0;">(Affiliated to University of Mumbai)</p>
                        <p style="font-size: 10pt; margin-top: 0.1in;">B.K. BIRLA COLLEGE CAMPUS ROAD, GAURIPADA, KALYAN (WEST) ‚Äì 421301</p>
                        
                        <h1 style="font-weight: bold; text-decoration: underline; font-size: 16pt; margin: 0.4in 0;">CERTIFICATE</h1>
                        
                        <p style="text-align: justify; line-height: 1.5;">
                            I hereby certify that, <strong>${studentName}</strong>, student of B.K. Birla Night College, studying in S.Y. BCom (A&F). Has completed a project title <strong>"${topic.topicname}"</strong> in the area commerce specialization for academic year 2025-26. To the best of my knowledge the work of the student is original and the information included in the project is correct.
                        </p>
                        
                        <table style="width: 100%; border: 0; font-weight: bold; margin-top: 0.6in; font-size: 12pt;">
                          <tr>
                            <td style="text-align: left;">Internal Guide</td>
                            <td style="text-align: center;">Head of the Department</td>
                            <td style="text-align: right;">Principal</td>
                          </tr>
                        </table>
                    </div>
                </div>
            `;

            const options = {
                margin: [1, 1, 1, 1.5], // [top, right, bottom, left] in inches
                filename: `Project_Documents_${student.name}.pdf`,
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: { scale: 3, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(contentHTML).set(options).save();
        }

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const studentIdParam = urlParams.get('id');

            if (!studentIdParam) {
                return showError("No Student ID Provided", "Please provide a student ID in the URL. Example: ?id=5241836");
            }

            try {
                const studentId = parseInt(studentIdParam, 10);
                if (isNaN(studentId)) {
                    return showError("Invalid Student ID", "The ID in the URL is not a valid number.");
                }
                
                const [student, projectData] = await Promise.all([fetchStudentData(studentId), fetchProjectData(studentId)]);
                
                currentStudentData = student;
                currentProjectData = projectData;

                document.getElementById('student-name').textContent = student.name;
                document.getElementById('student-id').textContent = `Student ID: ${student.studentid}`;
                const nameParts = student.name.trim().split(' ');
                const initials = nameParts.length > 1
                    ? `${nameParts[0][0]}${nameParts[nameParts.length - 1][0]}`
                    : nameParts[0].substring(0, 2);
                document.getElementById('student-initials').textContent = initials.toUpperCase();
                
                if (projectData.topic) {
                    document.getElementById('project-title').textContent = projectData.topic.topicname;
                    const projectTypeEl = document.getElementById('project-type');
                    projectTypeEl.textContent = student.type;

                    if (student.type && student.type.toLowerCase() === 'group') {
                        projectTypeEl.style.cssText = 'background-color: rgba(34, 197, 94, 0.2); color: #22c55e;';
                        displayTeamMembers(studentId, projectData.team);
                    } else {
                        projectTypeEl.style.cssText = 'background-color: rgba(59, 130, 246, 0.2); color: #3b82f6;';
                    }
                    
                    fetchAndDisplayFileUploadStatus(projectData.topic.topicid, studentId);
                } else {
                    document.getElementById('project-title').textContent = 'No project has been assigned to this student yet.';
                    document.getElementById('project-type-container').style.display = 'none';
                }

                loadingEl.style.display = 'none';
                projectDetailsEl.classList.remove('hidden');
                projectDetailsEl.classList.add('loaded');

            } catch (error) {
                console.error("Initialization failed:", error);
                showError("Error Loading Data", error.message);
            }
        };

        function displayTeamMembers(currentStudentId, teamMembers) {
            const teamMembersList = document.getElementById('team-members-list');
            const section = document.getElementById('team-members-section');
            teamMembersList.innerHTML = '';
            
            const otherMembers = teamMembers.filter(m => m.studentid !== currentStudentId);

            if (otherMembers.length > 0) {
                 otherMembers.forEach(member => {
                      const li = document.createElement('li');
                      li.innerHTML = `<span>${member.name}</span><span style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${member.studentid}</span>`;
                      teamMembersList.appendChild(li);
                 });
                 section.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
