<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Scanner - User-Friendly View</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            border: 2px solid #ccc;
            overflow: hidden;
        }
        video, canvas {
            width: 100%; height: auto; display: block;
        }
        #interactive.viewport canvas, #interactive.viewport video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        #toggle-scanner {
            display: block; width: 100%; padding: 12px; font-size: 16px;
            background-color: #007bff; color: white; border: none;
            border-radius: 5px; cursor: pointer; margin-bottom: 20px;
        }
        #toggle-scanner:hover { background-color: #0056b3; }

        /* NEW STYLES FOR PRODUCT CARD */
        #product-info {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .product-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .product-header img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .product-header-text h2 {
            margin: 0;
            font-size: 1.8em;
            color: #222;
        }
        .product-header-text p {
            margin: 5px 0 0;
            color: #666;
            font-size: 1.1em;
        }
        .product-section {
            margin-top: 20px;
        }
        .product-section h3 {
            margin-bottom: 10px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            font-size: 1.2em;
        }
        .scores-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .scores-container img {
            height: 60px;
        }
        .nutrition-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .nutrition-table th, .nutrition-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        .nutrition-table th { background-color: #f8f8f8; }
        .ingredients-text {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .allergens-container span {
            display: inline-block;
            background-color: #ffc107;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 5px 5px 5px 0;
            font-size: 0.9em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Product Information Scanner</h1>
    <p>Scan a product's barcode to see a neatly organized summary of its data.</p>
    <button id="toggle-scanner">Start Scanner</button>
    <div id="scanner-container" style="display: none;"><div id="interactive" class="viewport"></div></div>
    
    <div id="product-info">Waiting for scan...</div>

    <script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scannerContainer = document.getElementById('scanner-container');
            const toggleScannerBtn = document.getElementById('toggle-scanner');
            const productInfoDiv = document.getElementById('product-info');
            let isScannerActive = false;

            // --- SCANNER LOGIC (UNCHANGED) ---
            toggleScannerBtn.addEventListener('click', () => isScannerActive ? stopScanner() : startScanner());

            function startScanner() {
                Quagga.init({
                    inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { width: 640, height: 480, facingMode: "environment" }},
                    decoder: { readers: ["ean_reader", "upc_reader", "code_128_reader"] }
                }, (err) => {
                    if (err) { console.error(err); productInfoDiv.innerHTML = `<p style="color: red;">Error: Could not initialize scanner.</p>`; return; }
                    Quagga.start();
                    isScannerActive = true;
                    scannerContainer.style.display = 'block';
                    toggleScannerBtn.textContent = 'Stop Scanner';
                    productInfoDiv.innerHTML = 'Scanner is active. Point camera at a barcode.';
                });
                Quagga.onDetected(handleBarcodeDetection);
            }

            function stopScanner() {
                Quagga.stop();
                isScannerActive = false;
                scannerContainer.style.display = 'none';
                toggleScannerBtn.textContent = 'Start Scanner';
                productInfoDiv.innerHTML = 'Scanner is stopped.';
            }

            function handleBarcodeDetection(data) {
                const barcode = data.codeResult.code;
                productInfoDiv.innerHTML = `<p>Detected barcode: <strong>${barcode}</strong>. Fetching product info...</p>`;
                Quagga.stop();
                fetchProductInfo(barcode);
            }

            async function fetchProductInfo(barcode) {
                const apiUrl = `https://world.openfoodfacts.org/api/v2/product/${barcode}.json`;
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    if (data.status === 1) {
                        displayProductInfo(data.product);
                    } else {
                        productInfoDiv.innerHTML = `<p>Product with barcode <strong>${barcode}</strong> not found.</p>`;
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    productInfoDiv.innerHTML = `<p style="color: red;">An error occurred while fetching data.</p>`;
                } finally {
                    isScannerActive = false;
                    scannerContainer.style.display = 'none';
                    toggleScannerBtn.textContent = 'Start Scanner Again';
                }
            }

            // --- NEW & IMPROVED DISPLAY FUNCTION ---
            function displayProductInfo(product) {
                // Clear previous results
                productInfoDiv.innerHTML = ''; 
                
                // 1. Product Header
                const header = document.createElement('div');
                header.className = 'product-header';
                const imgSrc = product.image_front_url || 'https://static.openfoodfacts.org/images/icons/product_default.svg';
                header.innerHTML = `
                    <img src="${imgSrc}" alt="${product.product_name || 'Product Image'}">
                    <div class="product-header-text">
                        <h2>${product.product_name || 'Name not available'}</h2>
                        <p>${product.brands || ''} â€¢ ${product.quantity || ''}</p>
                    </div>
                `;
                productInfoDiv.appendChild(header);

                // 2. Scores Section
                const scoresSection = document.createElement('div');
                scoresSection.className = 'product-section';
                let scoresHTML = '<h3>Quick Summary âœ¨</h3><div class="scores-container">';
                if (product.nutriscore_grade) {
                    scoresHTML += `<img src="https://static.openfoodfacts.org/images/attributes/nutriscore-${product.nutriscore_grade}.svg" alt="Nutri-Score: ${product.nutriscore_grade.toUpperCase()}">`;
                }
                if (product.ecoscore_grade) {
                    scoresHTML += `<img src="https://static.openfoodfacts.org/images/attributes/ecoscore-${product.ecoscore_grade}.svg" alt="Eco-Score: ${product.ecoscore_grade.toUpperCase()}">`;
                }
                if (product.nova_group) {
                    scoresHTML += `<img src="https://static.openfoodfacts.org/images/attributes/nova-group-${product.nova_group}.svg" alt="NOVA Group: ${product.nova_group}">`;
                }
                 if (scoresHTML.endsWith('<div class="scores-container">')) {
                    scoresHTML += '<p>No summary scores available.</p>'; // Handle case with no scores
                }
                scoresHTML += '</div>';
                scoresSection.innerHTML = scoresHTML;
                productInfoDiv.appendChild(scoresSection);

                // 3. Nutrition Facts Table
                if (product.nutriments) {
                    const nutritionSection = document.createElement('div');
                    nutritionSection.className = 'product-section';
                    let tableHTML = `
                        <h3>Nutrition Facts ðŸ“Š</h3>
                        <table class="nutrition-table">
                            <tr><th>Nutrient</th><th>Value (per 100g)</th></tr>
                    `;
                    const nutrients = {
                        "Energy (kcal)": product.nutriments['energy-kcal_100g'],
                        "Fat": product.nutriments.fat_100g,
                        "Saturated Fat": product.nutriments['saturated-fat_100g'],
                        "Carbohydrates": product.nutriments.carbohydrates_100g,
                        "Sugars": product.nutriments.sugars_100g,
                        "Fiber": product.nutriments.fiber_100g,
                        "Protein": product.nutriments.proteins_100g,
                        "Salt": product.nutriments.salt_100g
                    };
                    for (const [name, value] of Object.entries(nutrients)) {
                        if (value !== undefined) {
                            tableHTML += `<tr><td>${name}</td><td>${value}${name.includes('kcal') ? '' : 'g'}</td></tr>`;
                        }
                    }
                    tableHTML += '</table>';
                    nutritionSection.innerHTML = tableHTML;
                    productInfoDiv.appendChild(nutritionSection);
                }

                // 4. Ingredients & Allergens
                const ingredientsSection = document.createElement('div');
                ingredientsSection.className = 'product-section';
                let ingredientsHTML = '<h3>Ingredients & Allergens ðŸŒ¿</h3>';
                if (product.ingredients_text) {
                    ingredientsHTML += `<p class="ingredients-text">${product.ingredients_text_with_allergens || product.ingredients_text}</p>`;
                }
                if (product.allergens_tags && product.allergens_tags.length > 0) {
                    ingredientsHTML += '<div class="allergens-container">';
                    product.allergens_tags.forEach(tag => {
                        ingredientsHTML += `<span>${tag.replace('en:', '').replace(/-/g, ' ')}</span>`;
                    });
                    ingredientsHTML += '</div>';
                }
                 if (!product.ingredients_text && (!product.allergens_tags || product.allergens_tags.length === 0)) {
                    ingredientsHTML += '<p>No ingredient or allergen information available.</p>';
                }
                ingredientsSection.innerHTML = ingredientsHTML;
                productInfoDiv.appendChild(ingredientsSection);
            }
        });
    </script>
</body>
</html>
